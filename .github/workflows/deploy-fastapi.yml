name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - main  

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 120s
          script: |
            echo "====== DEPLOY START ======"

            LOG_FILE="/home/ubuntu/ai-deploy.log"
            echo "ðŸª¶ [INFO] Logging full output to $LOG_FILE"

            {
              echo "ðŸ“¦ [STEP 1] Clean old repository"
              cd /home/ubuntu || exit 1
              rm -rf vitacheck-ai

              echo "ðŸ“¥ [STEP 2] Clone latest code"
              git clone --depth 1 https://github.com/VitaCheck/vitacheck-ai.git
              cd vitacheck-ai/fastapi-ocr || exit 1

              echo "ðŸ [STEP 3] Setup Python venv"
              if [ ! -d "venv_vc" ]; then
                python3 -m venv venv_vc
              fi
              source venv_vc/bin/activate

              echo "ðŸ“¦ [STEP 4] Install dependencies"
              pip install --upgrade pip -q
              pip install -r requirements.txt -q

              echo "ðŸ”‘ [STEP 5] Generate .env"
              if [ ! -f ".env" ]; then
                echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
              fi

              echo "âš™ï¸ [STEP 6] Setup PM2"
              if ! command -v pm2 &> /dev/null; then
                echo "Installing PM2..."
                sudo apt update -y > /dev/null 2>&1
                sudo apt install -y nodejs npm > /dev/null 2>&1
                sudo npm install -g pm2 > /dev/null 2>&1
              fi

              echo "ðŸ§¹ [STEP 7] Stop existing FastAPI process (if any)"
              if pm2 list | grep -q "fastapi-ocr"; then
                echo "Existing process found. Stopping it..."
                pm2 stop fastapi-ocr || true
                pm2 delete fastapi-ocr || true
              else
                echo "No existing FastAPI process found."
              fi

              echo "ðŸš€ [STEP 8] Start FastAPI fresh"
              pm2 start "uvicorn main:app --host 0.0.0.0 --port 8000" \
                --name fastapi-ocr --cwd /home/ubuntu/vitacheck-ai/fastapi-ocr \
                --interpreter bash --silent

              sleep 5

              # âœ… ìƒíƒœ ì ê²€
              STATUS=$(pm2 info fastapi-ocr | grep status | awk '{print $4}')
              if [ "$STATUS" != "online" ]; then
                echo "âŒ FastAPI failed to start properly (status=$STATUS)"
                echo "ðŸ“œ --- PM2 Logs ---"
                pm2 logs fastapi-ocr --lines 20
                echo "âŒ Deployment failed. Writing error to log file."
                pm2 logs fastapi-ocr --lines 50 >> $LOG_FILE 2>&1
                exit 1
              fi

              pm2 save --force > /dev/null 2>&1

              echo "âœ… [DONE] Deployment finished successfully"
            } >> $LOG_FILE 2>&1

            echo "====== DEPLOY SUMMARY ======"
            echo "ðŸ“„ Logs saved to: $LOG_FILE"
            tail -n 15 $LOG_FILE || echo "No log file found."
            echo "====== DEPLOY COMPLETE ======"
